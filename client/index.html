<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Support Group Events</title>
	<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen">
	<div class="max-w-4xl mx-auto px-4 py-8">
		<div class="flex justify-between items-center mb-8">
			<h1 class="text-3xl font-bold text-gray-800">Support Group Events</h1>
			<a href="/create-event.html" class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500">
				Create New Event
			</a>
		</div>
		
		<!-- Filter Button and Section -->
		<div class="mb-6">
			<button id="filterToggle" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-500">
				Filters
			</button>
			<div class="filter-section mt-4 bg-white rounded-lg shadow-md p-6" id="filterSection" style="display: none;">
				<form id="filterForm" class="space-y-4">
					<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
						<div>
							<label for="startDate" class="block text-sm font-medium text-gray-700 mb-1">Start Date:</label>
							<input type="date" id="startDate" name="startDate"
								class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
						</div>
						<div>
							<label for="endDate" class="block text-sm font-medium text-gray-700 mb-1">End Date:</label>
							<input type="date" id="endDate" name="endDate"
								class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
						</div>
					</div>
					
					<div>
						<label for="zipCode" class="block text-sm font-medium text-gray-700 mb-1">Zip Code:</label>
						<input type="text" id="zipCode" name="zipCode" pattern="[0-9]{5}" placeholder="12345"
							class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
					</div>
					
					<div>
						<label for="tags" class="block text-sm font-medium text-gray-700 mb-1">Tags:</label>
						<div class="tags-input-container">
							<div id="filter-tags-list" class="flex flex-wrap gap-2 mb-2"></div>
							<div id="selected-filter-tags" class="flex flex-wrap gap-2"></div>
						</div>
					</div>
					
					<div class="flex justify-end space-x-4">
						<button type="reset" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-500">
							Reset Filters
						</button>
						<button type="submit" class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500">
							Apply Filters
						</button>
					</div>
				</form>
			</div>
		</div>

		<!-- Events Container -->
		<div id="eventsContainer" class="space-y-4">
			<!-- Events will be dynamically inserted here -->
		</div>
	</div>

	<script src="filter-events.js"></script>

	<script>
		// DOM elements
		const eventList = document.getElementById('event-list');

		// Load all events when the page loads
		document.addEventListener('DOMContentLoaded', fetchEvents);

		// Fetch all events from the server
		async function fetchEvents() {
			try {
				const response = await fetch('/api/events');
				const events = await response.json();
				
				displayEvents(events);
			} catch (error) {
				console.error('Error fetching events:', error);
				eventList.innerHTML = '<li>Failed to load events. Please try again later.</li>';
			}
		}

		// Display events in the list
		function displayEvents(events) {
			const eventsContainer = document.getElementById('eventsContainer');
			
			if (events.length === 0) {
				eventsContainer.innerHTML = '<p class="text-gray-500 text-center py-4">No events yet. Create one!</p>';
				return;
			}

			eventsContainer.innerHTML = events.map(event => `
				<div class="bg-white rounded-lg shadow-md p-6 relative" data-id="${event._id}">
					<h3 class="text-xl font-semibold text-gray-800 mb-2">${event.name}</h3>
					<div class="space-y-2 text-gray-600">
						<p><span class="font-medium">Description:</span> ${event.description || 'No description provided'}</p>
						<p><span class="font-medium">Address:</span> ${event.address || 'No address provided'}</p>
						<p><span class="font-medium">Time:</span> ${event.time || 'No time provided'}</p>
						<p><span class="font-medium">Date:</span> ${event.date || 'No date provided'}</p>
					</div>
					<div class="absolute top-4 right-4 space-x-2">
						<button class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500"
							onclick="downloadICS('${event._id}', '${event.name}', '${event.description}', '${event.address}', '${event.date}', '${event.time}')">
							Add to iCal
						</button>
						<button class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500"
							onclick="deleteEvent('${event._id}')">
							Delete
						</button>
					</div>
				</div>
			`).join('');
		}

		// Delete an event
		async function deleteEvent(id) {
			if (!confirm('Are you sure you want to delete this event?')) {
				return;
			}
			
			try {
				const response = await fetch(`/api/events/${id}`, {
					method: 'DELETE'
				});

				if (!response.ok) {
					throw new Error('Failed to delete event');
				}

				// Reload events after deletion
				fetchEvents();
			} catch (error) {
				console.error('Error deleting event:', error);
				alert('Failed to delete event. Please try again.');
			}
		}

		// Generate and download ICS file
		function downloadICS(id, name, description, address, date, time) {
			// Format date and time for ICS
			const [year, month, day] = date.split('-');
			const [hours, minutes] = time.split(':');
			const [timeValue, period, timezone] = time.split(' ');
			
			// Convert to 24-hour format
			let hour24 = parseInt(hours);
			if (period === 'PM' && hour24 !== 12) hour24 += 12;
			if (period === 'AM' && hour24 === 12) hour24 = 0;
			
			// Create ICS content
			const icsContent = [
				'BEGIN:VCALENDAR',
				'VERSION:2.0',
				'PRODID:-//Support Group Search//Event Calendar//EN',
				'BEGIN:VEVENT',
				`DTSTART:${year}${month}${day}T${hour24.toString().padStart(2, '0')}${minutes}00`,
				`DTEND:${year}${month}${day}T${(hour24 + 1).toString().padStart(2, '0')}${minutes}00`,
				`SUMMARY:${name}`,
				`DESCRIPTION:${description}`,
				`LOCATION:${address}`,
				'END:VEVENT',
				'END:VCALENDAR'
			].join('\r\n');

			// Create blob and download
			const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
			const link = document.createElement('a');
			link.href = window.URL.createObjectURL(blob);
			link.setAttribute('download', `${name.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.ics`);
			document.body.appendChild(link);
			link.click();
			document.body.removeChild(link);
		}

		// Tag management for filters
		const filterTagsList = document.getElementById('filter-tags-list');
		const selectedFilterTags = document.getElementById('selected-filter-tags');
		let selectedFilterTagsSet = new Set();

		// Load existing tags for filter
		async function loadFilterTags() {
			try {
				const response = await fetch('/api/tags');
				const tags = await response.json();
				filterTagsList.innerHTML = tags.map(tag => `
					<button type="button" class="tag-btn" data-tag="${tag.name}">${tag.name}</button>
				`).join('');

				// Add click handlers to tag buttons
				document.querySelectorAll('.tag-btn').forEach(btn => {
					btn.addEventListener('click', () => toggleFilterTag(btn.dataset.tag));
				});
			} catch (error) {
				console.error('Error loading tags:', error);
			}
		}

		// Toggle filter tag selection
		function toggleFilterTag(tagName) {
			if (selectedFilterTagsSet.has(tagName)) {
				selectedFilterTagsSet.delete(tagName);
			} else {
				selectedFilterTagsSet.add(tagName);
			}
			updateSelectedFilterTagsDisplay();
		}

		// Update selected filter tags display
		function updateSelectedFilterTagsDisplay() {
			selectedFilterTags.innerHTML = Array.from(selectedFilterTagsSet).map(tag => `
				<span class="tag">
					${tag}
					<button type="button" class="remove-tag" onclick="toggleFilterTag('${tag}')">&times;</button>
				</span>
			`).join('');
		}

		// Load tags when page loads
		document.addEventListener('DOMContentLoaded', () => {
			loadFilterTags();
		});

		// Modify filter form submission
		document.getElementById('filterForm').addEventListener('submit', function(e) {
			e.preventDefault();
			const formData = new FormData(this);
			const params = new URLSearchParams();

			// Add date range
			if (formData.get('startDate')) {
				params.append('startDate', formData.get('startDate'));
			}
			if (formData.get('endDate')) {
				params.append('endDate', formData.get('endDate'));
			}

			// Add zip code
			if (formData.get('zipCode')) {
				params.append('zipCode', formData.get('zipCode'));
			}

			// Add selected tags
			if (selectedFilterTagsSet.size > 0) {
				params.append('tags', Array.from(selectedFilterTagsSet).join(','));
			}

			// Fetch filtered events
			fetch(`/api/events?${params.toString()}`)
				.then(response => response.json())
				.then(events => {
					displayEvents(events);
				})
				.catch(error => {
					console.error('Error fetching filtered events:', error);
					alert('Error fetching events. Please try again.');
				});
		});

		// Reset filter form
		document.getElementById('filterForm').addEventListener('reset', function() {
			selectedFilterTagsSet.clear();
			updateSelectedFilterTagsDisplay();
			fetchEvents();
		});
	</script>
</body>
</html>