<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Support Group Events</title>
	<script src="https://cdn.tailwindcss.com"></script>
	<link href="https://fonts.googleapis.com/css2?family=Actor&family=Forum&display=swap" rel="stylesheet">
	<script>
		tailwind.config = {
			theme: {
				extend: {
					colors: {
						primary: '#2D3047',    // Maven's dark blue
						secondary: '#419D78',  // Maven's green
						accent: '#E0A458',     // Maven's gold
						light: '#F7F7F7',      // Maven's light gray
						dark: '#1A1B1E'        // Maven's dark gray
					},
					fontFamily: {
						'actor': ['Actor', 'sans-serif'],
						'forum': ['Forum', 'serif']
					}
				}
			}
		}
	</script>
</head>
<body class="bg-light min-h-screen font-actor">
	<div class="max-w-5xl mx-auto px-4 py-12">
		<div class="flex justify-between items-center mb-12">
			<h1 class="text-4xl font-forum font-bold text-primary">Support Group Events</h1>
			<a href="/create-event.html" 
				class="px-6 py-3 bg-secondary text-white rounded-lg hover:bg-opacity-90 transition-all duration-200 font-actor shadow-sm">
				Create New Event
			</a>
		</div>
		
		<!-- Filter Button and Section -->
		<div class="mb-8">
			<button id="filterToggle" 
				class="px-5 py-2.5 bg-white text-primary border border-gray-200 rounded-lg hover:bg-gray-50 transition-all duration-200 font-actor shadow-sm">
				Filters
			</button>
			<div class="filter-section mt-6 bg-white rounded-xl shadow-lg p-8" id="filterSection" style="display: none;">
				<form id="filterForm" class="space-y-6">
					<!-- Date Range -->
					<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
						<div>
							<label for="startDate" class="block text-sm font-forum text-primary mb-2">Start Date</label>
							<input type="date" id="startDate" name="startDate"
								class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-secondary focus:border-transparent font-actor">
						</div>
						<div>
							<label for="endDate" class="block text-sm font-forum text-primary mb-2">End Date</label>
							<input type="date" id="endDate" name="endDate"
								class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-secondary focus:border-transparent font-actor">
						</div>
					</div>

					<!-- Zip Code -->
					<div>
						<label for="filterZipCode" class="block text-sm font-forum text-primary mb-2">Zip Code</label>
						<input type="text" id="filterZipCode" name="zipCode" pattern="[0-9]{5}"
							class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-secondary focus:border-transparent font-actor">
					</div>

					<!-- Tags -->
					<div>
						<label class="block text-sm font-forum text-primary mb-2">Tags</label>
						<div class="space-y-4">
							<!-- Selected tags will appear here -->
							<div id="selected-filter-tags" class="flex flex-wrap gap-2">
							</div>
							
							<!-- Available tags -->
							<div id="filter-tags-list" class="flex flex-wrap gap-2">
								<!-- Tags will be populated by JavaScript -->
							</div>
						</div>
					</div>

					<div class="flex justify-end space-x-4">
						<button type="reset" 
							class="px-5 py-2.5 bg-white text-primary border border-gray-200 rounded-lg hover:bg-gray-50 transition-all duration-200 font-actor shadow-sm">
							Reset Filters
						</button>
						<button type="submit" 
							class="px-5 py-2.5 bg-secondary text-white rounded-lg hover:bg-opacity-90 transition-all duration-200 font-actor shadow-sm">
							Apply Filters
						</button>
					</div>
				</form>
			</div>
		</div>

		<!-- Events Container -->
		<div id="eventsContainer" class="space-y-6">
			<!-- Events will be dynamically inserted here -->
		</div>
	</div>

	<script src="filter-events.js"></script>

	<script>
		// DOM elements
		const eventList = document.getElementById('event-list');

		// Load all events when the page loads
		document.addEventListener('DOMContentLoaded', fetchEvents);

		// Fetch all events from the server
		async function fetchEvents() {
			try {
				const response = await fetch('/api/events');
				const events = await response.json();
				
				displayEvents(events);
			} catch (error) {
				console.error('Error fetching events:', error);
				eventList.innerHTML = '<li>Failed to load events. Please try again later.</li>';
			}
		}

		// Display events in the list
		function displayEvents(events) {
			const eventsContainer = document.getElementById('eventsContainer');
			
			if (events.length === 0) {
				eventsContainer.innerHTML = '<p class="text-gray-500 text-center py-8 text-lg font-actor">No events yet. Create one!</p>';
				return;
			}

			eventsContainer.innerHTML = events.map(event => `
				<div class="bg-white rounded-xl shadow-lg p-8 relative" data-id="${event._id}">
					<h3 class="text-2xl font-forum font-bold text-primary mb-4">${event.name}</h3>
					<div class="space-y-3 text-gray-600 font-actor">
						<p><span class="font-forum text-primary">Description:</span> ${event.description || 'No description provided'}</p>
						<p><span class="font-forum text-primary">Address:</span> ${event.address || 'No address provided'}</p>
						<p><span class="font-forum text-primary">Time:</span> ${event.time || 'No time provided'}</p>
						<p><span class="font-forum text-primary">Date:</span> ${event.date || 'No date provided'}</p>
					</div>
					<div class="absolute top-6 right-6 space-x-3">
						<button class="px-4 py-2 bg-secondary text-white rounded-lg hover:bg-opacity-90 transition-all duration-200 font-actor shadow-sm"
							onclick="downloadICS('${event._id}', '${event.name}', '${event.description}', '${event.address}', '${event.date}', '${event.time}')">
							Add to iCal
						</button>
						<button class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-opacity-90 transition-all duration-200 font-actor shadow-sm"
							onclick="deleteEvent('${event._id}')">
							Delete
						</button>
					</div>
				</div>
			`).join('');
		}

		// Delete an event
		async function deleteEvent(id) {
			if (!confirm('Are you sure you want to delete this event?')) {
				return;
			}
			
			try {
				const response = await fetch(`/api/events/${id}`, {
					method: 'DELETE'
				});

				if (!response.ok) {
					throw new Error('Failed to delete event');
				}

				// Reload events after deletion
				fetchEvents();
			} catch (error) {
				console.error('Error deleting event:', error);
				alert('Failed to delete event. Please try again.');
			}
		}

		// Generate and download ICS file
		function downloadICS(id, name, description, address, date, time) {
			// Format date and time for ICS
			const [year, month, day] = date.split('-');
			const [hours, minutes] = time.split(':');
			const [timeValue, period, timezone] = time.split(' ');
			
			// Convert to 24-hour format
			let hour24 = parseInt(hours);
			if (period === 'PM' && hour24 !== 12) hour24 += 12;
			if (period === 'AM' && hour24 === 12) hour24 = 0;
			
			// Create ICS content
			const icsContent = [
				'BEGIN:VCALENDAR',
				'VERSION:2.0',
				'PRODID:-//Support Group Search//Event Calendar//EN',
				'BEGIN:VEVENT',
				`DTSTART:${year}${month}${day}T${hour24.toString().padStart(2, '0')}${minutes}00`,
				`DTEND:${year}${month}${day}T${(hour24 + 1).toString().padStart(2, '0')}${minutes}00`,
				`SUMMARY:${name}`,
				`DESCRIPTION:${description}`,
				`LOCATION:${address}`,
				'END:VEVENT',
				'END:VCALENDAR'
			].join('\r\n');

			// Create blob and download
			const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
			const link = document.createElement('a');
			link.href = window.URL.createObjectURL(blob);
			link.setAttribute('download', `${name.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.ics`);
			document.body.appendChild(link);
			link.click();
			document.body.removeChild(link);
		}

		// Tag management for filters
		const filterTagsList = document.getElementById('filter-tags-list');
		const selectedFilterTags = document.getElementById('selected-filter-tags');
		let selectedFilterTagsSet = new Set();

		// Load existing tags for filter
		async function loadFilterTags() {
			try {
				const response = await fetch('/api/tags');
				const tags = await response.json();
				filterTagsList.innerHTML = tags.map(tag => `
					<button type="button" 
						class="px-4 py-2 bg-light text-primary rounded-lg hover:bg-gray-100 transition-all duration-200 font-actor"
						data-tag="${tag.name}">
						${tag.name}
					</button>
				`).join('');

				// Add click handlers to tag buttons
				document.querySelectorAll('.tag-btn').forEach(btn => {
					btn.addEventListener('click', () => toggleFilterTag(btn.dataset.tag));
				});
			} catch (error) {
				console.error('Error loading tags:', error);
			}
		}

		// Toggle filter tag selection
		function toggleFilterTag(tagName) {
			if (selectedFilterTagsSet.has(tagName)) {
				selectedFilterTagsSet.delete(tagName);
			} else {
				selectedFilterTagsSet.add(tagName);
			}
			updateSelectedFilterTagsDisplay();
		}

		// Update selected filter tags display
		function updateSelectedFilterTagsDisplay() {
			selectedFilterTags.innerHTML = Array.from(selectedFilterTagsSet).map(tag => `
				<span class="inline-flex items-center px-4 py-2 bg-secondary bg-opacity-10 text-secondary rounded-lg font-actor">
					${tag}
					<button type="button" 
						class="ml-2 text-secondary hover:text-opacity-80 transition-all duration-200"
						onclick="toggleFilterTag('${tag}')">
						&times;
					</button>
				</span>
			`).join('');
		}

		// Load tags when page loads
		document.addEventListener('DOMContentLoaded', () => {
			loadFilterTags();
		});

		// Modify filter form submission
		document.getElementById('filterForm').addEventListener('submit', function(e) {
			e.preventDefault();
			const formData = new FormData(this);
			const params = new URLSearchParams();

			// Add date range
			if (formData.get('startDate')) {
				params.append('startDate', formData.get('startDate'));
			}
			if (formData.get('endDate')) {
				params.append('endDate', formData.get('endDate'));
			}

			// Add zip code
			if (formData.get('zipCode')) {
				params.append('zipCode', formData.get('zipCode'));
			}

			// Add selected tags
			if (selectedFilterTagsSet.size > 0) {
				params.append('tags', Array.from(selectedFilterTagsSet).join(','));
			}

			// Fetch filtered events
			fetch(`/api/events?${params.toString()}`)
				.then(response => response.json())
				.then(events => {
					displayEvents(events);
				})
				.catch(error => {
					console.error('Error fetching filtered events:', error);
					alert('Error fetching events. Please try again.');
				});
		});

		// Reset filter form
		document.getElementById('filterForm').addEventListener('reset', function() {
			selectedFilterTagsSet.clear();
			updateSelectedFilterTagsDisplay();
			fetchEvents();
		});
	</script>
</body>
</html>